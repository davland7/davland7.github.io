---
import Layout from '../../layouts/Layout.astro';
import StationCard from '../../components/StationCard.astro';
import { fetchStationsByTerm, getCategoriesByType } from '../../lib/radioBrowser';
import { SearchType, type RadioStation, type Term } from '../../lib/types';
import { pageIntros } from '../../lib/content';

type CategoryListProps = {
	type: "category";
	categoryName: string;
	categorySlug: string;
	categories: Term[];
};

type StationsProps = {
	type: "stations";
	categoryName: string;
	categorySlug: string;
	itemName: string;
	stations: RadioStation[];
};

type Props = CategoryListProps | StationsProps;

export async function getStaticPaths() {
	const categories = [
		{ type: SearchType.Country, name: "Countries", slug: "countries" },
		{ type: SearchType.Tag, name: "Genres", slug: "genres" },
	];

	const limitStations = 128;
	const paths: any[] = [];

	for (const category of categories) {
		const { slug, type, name } = category;
		const categoryItems = await getCategoriesByType(type);

		// Category list page
		paths.push({
			params: { category: slug, slug: undefined },
			props: {
				type: "category",
				categoryName: name,
				categorySlug: slug,
				categories: categoryItems,
			},
		});

		// Individual station pages
		for (const item of categoryItems) {
			const stations = await fetchStationsByTerm({
				term: item.name,
				type,
				limit: limitStations,
			});

			paths.push({
				params: { category: slug, slug: item.slug },
				props: {
					type: "stations",
					categoryName: name,
					categorySlug: slug,
					itemName: item.name,
					stations,
				},
			});
		}
	}

	return paths;
}

const props = Astro.props as Props;
const buildDate = new Date().toISOString().split("T")[0];
---

<Layout isStationPage={props.type === "stations"}>
  {props.type === "category" && (
    <>
      <nav>
        <a href="/">Home</a> / {props.categoryName}
      </nav>
      <p>
        Search by: <a href={props.categorySlug === "countries" ? "/genres" : "/countries"}>
          {props.categorySlug === "countries" ? "Genres" : "Countries"}
        </a>
      </p>
      <h1>{pageIntros.category[props.categorySlug]?.title || props.categoryName}</h1>
      <p>{pageIntros.category[props.categorySlug]?.description}</p>
      <p>
        {props.categories.map((item, index) => (
          <>
            <a href={`/${props.categorySlug}/${item.slug}`}>{item.name}</a>{index < props.categories.length - 1 && ', '}
          </>
        ))}
      </p>
    </>
  )}

  {props.type === "stations" && (
    <>
      <nav>
        <a href="/">Home</a> / <a href={`/${props.categorySlug}`}>{props.categoryName}</a> / {props.itemName}
      </nav>
      Data provided by <a href="https://www.radio-browser.info" target="_blank">RadioBrowser</a>.
      <h1>{props.itemName}</h1>
      <p>
        {props.categorySlug === "countries"
          ? pageIntros.stations.country
          : pageIntros.stations.tag}
        {' '}Test with <a href="https://rplayer.js.org/" target="_blank">RPlayer</a>.
      </p>
		  <div class="station-grid">
        {props.stations.map((station) => (
          <StationCard station={station} />
        ))}
      </div>
      <footer>
        Generated on {buildDate}.
      </footer>
    </>
  )}
</Layout>

<style>
  nav {
    height: var(--space-xl);
    text-transform: capitalize;
  }

	.station-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: var(--space-lg);
    margin: var(--space-xl) 0;
	}
</style>
